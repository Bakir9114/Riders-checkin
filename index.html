<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RCIS (Rider Check-In System)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0D1117;
            color: #C9D1D9;
        }

        .glass-card {
            background: rgba(22, 27, 34, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(48, 54, 61, 0.5);
            border-radius: 16px;
        }

        .btn-gradient {
            background-image: linear-gradient(to right, #1F6FEB, #2D9CDB);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px 0 rgba(49, 196, 190, 0.3);
        }

        .btn-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 rgba(49, 196, 190, 0.4);
        }

        .input-field {
            background-color: #161B22;
            border: 1px solid #30363D;
            color: #C9D1D9;
        }

        .input-field:focus {
            outline: none;
            border-color: #1F6FEB;
            box-shadow: 0 0 0 3px rgba(31, 111, 235, 0.3);
        }

        #video,
        #canvas {
            border-radius: 12px;
            border: 1px solid #30363D;
        }
        
        .password-container {
            position: relative;
        }
        
        .eye-icon {
            position: absolute;
            top: 50%;
            right: 12px;
            transform: translateY(-50%);
            cursor: pointer;
            color: #8B949E;
        }
    </style>
</head>

<body class="flex items-center justify-center min-h-screen p-4">

    <div id="app" class="w-full max-w-md mx-auto">
        <!-- Login Screen -->
        <div id="loginScreen" class="glass-card p-6 md:p-8 space-y-6">
            <h1 class="text-2xl sm:text-3xl font-bold text-center text-white whitespace-nowrap">RCIS (Rider Check-In System)</h1>
            <div class="space-y-4">
                <div>
                    <label for="riderId" class="block mb-2 text-sm font-medium">Enter Your Rider ID</label>
                    <input type="text" id="riderId" class="input-field w-full p-3 rounded-lg text-center" placeholder="E.G., FAR001" autocomplete="off">
                </div>
                <div>
                    <label for="secretPin" class="block mb-2 text-sm font-medium">Enter Your Secret PIN</label>
                     <div class="password-container">
                        <input type="password" id="secretPin" class="input-field w-full p-3 rounded-lg text-center" placeholder="••••••" autocomplete="off">
                        <i class="fas fa-eye eye-icon" id="togglePin"></i>
                    </div>
                </div>
            </div>
            <button id="loginBtn" class="w-full btn-gradient text-white font-bold py-3 px-4 rounded-lg">Login</button>
        </div>

        <!-- Main Screen -->
        <div id="mainScreen" class="hidden glass-card p-6 md:p-8 space-y-6">
            <div class="text-center">
                <h2 class="text-2xl font-bold text-white">Welcome, <span id="riderNameDisplay"></span>!</h2>
                <p class="text-sm text-gray-400">ID: <span id="riderIdDisplay"></span></p>
            </div>
            
            <div id="geminiTipCard" class="bg-gray-800 p-4 rounded-lg border border-gray-700 hidden">
                 <p class="text-center font-bold text-lg mb-2 text-blue-400">✨ Aaj Ka Tip ✨</p>
                 <p id="geminiTip" class="text-sm text-center text-gray-300">Loading your daily tip...</p>
            </div>

            <div id="actionButtons" class="space-y-4">
                 <div id="shiftSelection" class="hidden">
                    <label for="shiftTime" class="block mb-2 text-sm font-medium">Select Shift Time</label>
                    <select id="shiftTime" class="input-field w-full p-3 rounded-lg">
                        <option>8 AM to 5 PM</option>
                        <option>5 PM to 2 AM</option>
                    </select>
                 </div>
                <button id="checkInBtn" class="w-full btn-gradient text-white font-bold py-3 px-4 rounded-lg">Check-In</button>
                <button id="checkOutBtn" class="w-full bg-gray-600 text-white font-bold py-3 px-4 rounded-lg" disabled>Check-Out</button>
            </div>
        </div>

        <!-- Location Screen -->
        <div id="locationScreen" class="hidden glass-card p-6 md:p-8 space-y-6 text-center">
             <h2 id="locationScreenTitle" class="text-2xl font-bold text-white">Verifying Location...</h2>
             <div class="flex justify-center items-center h-24">
                  <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
             </div>
             <p id="locationStatus" class="text-gray-400">Please wait, we are checking your location.</p>
             <p id="timerDisplay" class="text-yellow-400 font-bold text-lg hidden"></p>
        </div>
        
        <!-- Camera Screen -->
        <div id="cameraScreen" class="hidden glass-card p-6 md:p-8 space-y-4">
            <h2 id="cameraScreenTitle" class="text-2xl font-bold text-white text-center">Take Selfie</h2>
            <video id="video" class="w-full" autoplay playsinline></video>
            <canvas id="canvas" class="hidden"></canvas>
            <button id="snapBtn" class="w-full btn-gradient text-white font-bold py-3 px-4 rounded-lg">Capture Selfie</button>
        </div>

        <!-- Checkout Form Screen -->
        <div id="checkoutFormScreen" class="hidden glass-card p-6 md:p-8 space-y-4">
             <h2 class="text-2xl font-bold text-white text-center">Enter Checkout Details</h2>
              <div>
                  <label class="block mb-2 text-sm font-medium">Total Rides Today (System)</label>
                  <input type="number" id="totalRides" class="input-field w-full p-3 rounded-lg">
              </div>
              <div>
                  <label class="block mb-2 text-sm font-medium">Total KMs Travelled (System)</label>
                  <input type="number" id="totalKms" class="input-field w-full p-3 rounded-lg">
              </div>
              <div>
                  <label class="block mb-2 text-sm font-medium">Last Order Delivered?</label>
                  <select id="lastOrder" class="input-field w-full p-3 rounded-lg">
                      <option>Yes</option>
                      <option>No</option>
                  </select>
              </div>
              <div>
                  <label class="block mb-2 text-sm font-medium">Last Order Pick-up Time</label>
                  <input type="time" id="lastOrderTime" class="input-field w-full p-3 rounded-lg">
              </div>
               <div>
                  <label class="block mb-2 text-sm font-medium">Total Manual Orders</label>
                  <input type="number" id="manualOrders" class="input-field w-full p-3 rounded-lg">
              </div>
              <div>
                  <label class="block mb-2 text-sm font-medium">Total Manual KMs</label>
                  <input type="number" id="manualKms" class="input-field w-full p-3 rounded-lg">
              </div>
              
            <div id="geminiSummaryCard" class="bg-gray-800 p-4 rounded-lg border border-gray-700 hidden mt-4">
                 <p class="text-center font-bold text-lg mb-2 text-green-400">✨ Shift Summary ✨</p>
                 <p id="geminiSummary" class="text-sm text-center text-gray-300">Enter details to get summary.</p>
            </div>

            <button id="getSummaryBtn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg mt-2">Get Shift Summary</button>
            <button id="submitCheckoutBtn" class="w-full btn-gradient text-white font-bold py-3 px-4 rounded-lg mt-2">Proceed to Selfie</button>
        </div>

        <!-- Message Modal -->
        <div id="messageModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4">
            <div class="glass-card p-6 rounded-lg text-center max-w-sm w-full space-y-4">
                <h3 id="modalTitle" class="text-xl font-bold text-white"></h3>
                <p id="modalMessage" class="text-gray-300"></p>
                <button id="modalOkBtn" class="btn-gradient text-white font-bold py-2 px-6 rounded-lg">OK</button>
            </div>
        </div>
    </div>

    <script>
        const APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyUhsEV7GxKRfUhsEV7GxKRfUfQFKH2REGCXhMxY1QWVaEJd8eSxGBCw4YOglA5mjcPD_Qu4sE5g32Eg/exec';

        // --- DOM Elements ---
        const loginScreen = document.getElementById('loginScreen');
        const mainScreen = document.getElementById('mainScreen');
        const locationScreen = document.getElementById('locationScreen');
        const cameraScreen = document.getElementById('cameraScreen');
        const checkoutFormScreen = document.getElementById('checkoutFormScreen');

        const riderIdInput = document.getElementById('riderId');
        const secretPinInput = document.getElementById('secretPin');
        const togglePin = document.getElementById('togglePin');
        const loginBtn = document.getElementById('loginBtn');

        const riderNameDisplay = document.getElementById('riderNameDisplay');
        const riderIdDisplay = document.getElementById('riderIdDisplay');
        
        const geminiTipCard = document.getElementById('geminiTipCard');
        const geminiTip = document.getElementById('geminiTip');
        const geminiSummaryCard = document.getElementById('geminiSummaryCard');
        const geminiSummary = document.getElementById('geminiSummary');
        const getSummaryBtn = document.getElementById('getSummaryBtn');

        const actionButtons = document.getElementById('actionButtons');
        const shiftSelection = document.getElementById('shiftSelection');
        const shiftTimeSelect = document.getElementById('shiftTime');
        const checkInBtn = document.getElementById('checkInBtn');
        const checkOutBtn = document.getElementById('checkOutBtn');

        const locationScreenTitle = document.getElementById('locationScreenTitle');
        const locationStatus = document.getElementById('locationStatus');
        const timerDisplay = document.getElementById('timerDisplay');
        
        const cameraScreenTitle = document.getElementById('cameraScreenTitle');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const snapBtn = document.getElementById('snapBtn');

        const submitCheckoutBtn = document.getElementById('submitCheckoutBtn');
        
        const messageModal = document.getElementById('messageModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalOkBtn = document.getElementById('modalOkBtn');
        
        // --- App State ---
        let riderData = null;
        let submissionType = ''; // 'checkin' or 'checkout'
        let stream = null;
        let checkoutDetails = {};
        let refreshTimer = null;

        // --- Geofencing Config ---
        const OFFICE_COORDINATES = {
            latitude: 28.460845,
            longitude: 77.079439
        };
        const ALLOWED_RADIUS_METERS = 200;

        // --- Event Listeners ---
        loginBtn.addEventListener('click', handleLogin);
        checkInBtn.addEventListener('click', () => startProcess('checkin'));
        checkOutBtn.addEventListener('click', () => startProcess('checkout'));
        snapBtn.addEventListener('click', captureSelfie);
        modalOkBtn.addEventListener('click', () => messageModal.classList.add('hidden'));
        submitCheckoutBtn.addEventListener('click', proceedToCheckoutSelfie);
        togglePin.addEventListener('click', togglePasswordVisibility);
        getSummaryBtn.addEventListener('click', getShiftSummary);


        // --- Functions ---
        
        function togglePasswordVisibility() {
            const isPassword = secretPinInput.type === 'password';
            secretPinInput.type = isPassword ? 'text' : 'password';
            togglePin.classList.toggle('fa-eye');
            togglePin.classList.toggle('fa-eye-slash');
        }

        function showScreen(screen) {
            [loginScreen, mainScreen, locationScreen, cameraScreen, checkoutFormScreen].forEach(s => s.classList.add('hidden'));
            screen.classList.remove('hidden');
        }

        function showMessage(title, message, onOk) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            messageModal.classList.remove('hidden');
            if(onOk) {
                 modalOkBtn.onclick = () => {
                    messageModal.classList.add('hidden');
                    onOk();
                };
            } else {
                 modalOkBtn.onclick = () => messageModal.classList.add('hidden');
            }
        }

        async function handleLogin() {
            const riderId = riderIdInput.value.trim().toUpperCase();
            const secretPin = secretPinInput.value.trim();

            if (!riderId || !secretPin) {
                showMessage('Error', 'Please enter both Rider ID and Secret PIN.');
                return;
            }

            showMessage('Logging In...', 'Please wait while we verify your credentials.');
            
            try {
                const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'login', riderId, secretPin }),
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();
                modalOkBtn.click(); // Hide loading message

                if (result.status === 'success') {
                    riderData = result.data;
                    riderNameDisplay.textContent = riderData.riderName;
                    riderIdDisplay.textContent = riderData.riderId;
                    
                    updateUIBasedOnLogin();
                    getDailyTip();
                    showScreen(mainScreen);

                } else {
                    showMessage('Login Failed', result.message || 'Invalid Rider ID or PIN.');
                }
            } catch (error) {
                showMessage('Network Error', 'Could not connect to the server. Please check your internet connection.');
            }
        }

        function updateUIBasedOnLogin() {
            // Logic for enabling/disabling buttons based on shift status
            const { checkInCountToday, checkedInShifts } = riderData;
            
            const morningShift = "8 AM to 5 PM";
            const eveningShift = "5 PM to 2 AM";

            const hasDoneMorning = checkedInShifts.includes(morningShift);
            const hasDoneEvening = checkedInShifts.includes(eveningShift);
            
            // By default, disable checkout
            checkOutBtn.disabled = true;
            checkOutBtn.classList.add('bg-gray-600');
            checkOutBtn.classList.remove('btn-gradient');

            if (checkInCountToday === 0) {
                // First check-in of the day
                shiftSelection.classList.remove('hidden');
                checkInBtn.disabled = false;
                checkInBtn.classList.remove('bg-gray-600');
                checkInBtn.classList.add('btn-gradient');
            } else if (checkInCountToday === 1) {
                // One shift already done
                checkOutBtn.disabled = false;
                checkOutBtn.classList.remove('bg-gray-600');
                checkOutBtn.classList.add('btn-gradient');
                
                // Allow second shift
                shiftSelection.classList.remove('hidden');
                // Remove the completed shift from options
                shiftTimeSelect.innerHTML = `<option>${morningShift}</option><option>${eveningShift}</option>`;
                if(hasDoneMorning) {
                    shiftTimeSelect.querySelector(`option[value='${morningShift}']`).remove();
                }
                if(hasDoneEvening) {
                     shiftTimeSelect.querySelector(`option[value='${eveningShift}']`).remove();
                }
                
                checkInBtn.disabled = false;
                checkInBtn.classList.remove('bg-gray-600');
                checkInBtn.classList.add('btn-gradient');

            } else if (checkInCountToday >= 2) {
                // Both shifts done for the day
                shiftSelection.classList.add('hidden');
                checkInBtn.disabled = true;
                checkInBtn.classList.add('bg-gray-600');
                checkInBtn.classList.remove('btn-gradient');

                checkOutBtn.disabled = false; // Allow checkout for the last shift
                checkOutBtn.classList.remove('bg-gray-600');
                checkOutBtn.classList.add('btn-gradient');
            }
        }


        function startProcess(type) {
             const selectedShift = shiftTimeSelect.value;
             if(type === 'checkin' && riderData.checkedInShifts.includes(selectedShift)) {
                showMessage('Error', `You have already checked-in for the shift: ${selectedShift}`);
                return;
             }
             
            submissionType = type;
            if (type === 'checkout') {
                showScreen(checkoutFormScreen);
            } else {
                locationScreenTitle.textContent = 'Verifying Location for Check-In...';
                showScreen(locationScreen);
                verifyLocation();
            }
        }
        
        function proceedToCheckoutSelfie() {
             checkoutDetails = {
                totalRides: document.getElementById('totalRides').value,
                totalKms: document.getElementById('totalKms').value,
                lastOrder: document.getElementById('lastOrder').value,
                lastOrderTime: document.getElementById('lastOrderTime').value,
                manualOrders: document.getElementById('manualOrders').value,
                manualKms: document.getElementById('manualKms').value
            };
            locationScreenTitle.textContent = 'Verifying Location for Check-Out...';
            showScreen(locationScreen);
            verifyLocation();
        }

        function verifyLocation() {
            locationStatus.textContent = 'Please wait, we are checking your location.';
            if (!navigator.geolocation) {
                showMessage('Error', 'Geolocation is not supported by your browser.');
                showScreen(mainScreen);
                return;
            }

            navigator.geolocation.getCurrentPosition(
                position => {
                    const { latitude, longitude } = position.coords;
                    const distance = calculateDistance(latitude, longitude, OFFICE_COORDINATES.latitude, OFFICE_COORDINATES.longitude);

                    if (distance <= ALLOWED_RADIUS_METERS) {
                        locationStatus.textContent = 'Location verified successfully!';
                        startRefreshTimer();
                        getReverseGeocode(latitude, longitude).then(address => {
                           startCamera(latitude, longitude, address);
                        });
                    } else {
                        showMessage('Location Error', `You are ${Math.round(distance)} meters away. Please be within ${ALLOWED_RADIUS_METERS} meters of the office to proceed.`, () => showScreen(mainScreen));
                    }
                },
                () => {
                    showMessage('Location Error', 'Unable to retrieve your location. Please ensure location services are enabled and permissions are granted.', () => showScreen(mainScreen));
                },
                { enableHighAccuracy: true }
            );
        }

        function startRefreshTimer() {
            let timeLeft = 120; // 2 minutes
            timerDisplay.classList.remove('hidden');
            
            refreshTimer = setInterval(() => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerDisplay.textContent = `Time left: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                timeLeft--;

                if (timeLeft < 0) {
                    clearInterval(refreshTimer);
                    showMessage('Time Up!', 'Your session has expired. Please verify your location again.', () => {
                        stopCamera();
                        showScreen(mainScreen);
                    });
                }
            }, 1000);
        }

        async function startCamera(latitude, longitude, address) {
            cameraScreenTitle.textContent = submissionType === 'checkin' ? 'Take Check-In Selfie' : 'Take Check-Out Selfie';
            showScreen(cameraScreen);
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                video.srcObject = stream;
                video.dataset.latitude = latitude;
                video.dataset.longitude = longitude;
                video.dataset.address = address;
            } catch (err) {
                showMessage('Camera Error', 'Could not access the camera. Please grant camera permissions.', () => showScreen(mainScreen));
            }
        }
        
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            clearInterval(refreshTimer);
            timerDisplay.classList.add('hidden');
        }

        function captureSelfie() {
            const context = canvas.getContext('2d');
            const videoWidth = video.videoWidth;
            const videoHeight = video.videoHeight;
            canvas.width = videoWidth;
            canvas.height = videoHeight;
            
            // Draw video frame onto canvas
            context.drawImage(video, 0, 0, videoWidth, videoHeight);
            
            // Prepare text for overlay
            const timestamp = new Date().toLocaleString('en-IN', { timeZone: "Asia/Kolkata" });
            const address = video.dataset.address || 'Address not found';
            
            const textLines = [
                timestamp,
                address
            ];

            // Add text overlay
            context.font = '24px Inter';
            context.fillStyle = 'rgba(0, 0, 0, 0.5)';
            context.fillRect(0, videoHeight - (textLines.length * 30 + 15), videoWidth, (textLines.length * 30 + 15));
            context.fillStyle = 'white';
            
            textLines.forEach((line, index) => {
                context.fillText(line, 15, videoHeight - (textLines.length * 30) + (index * 30));
            });
            
            const selfie = canvas.toDataURL('image/jpeg');
            stopCamera();
            submitData(selfie);
        }

        async function submitData(selfie) {
            showMessage('Submitting...', 'Please wait while we save your data.');

            let dataToSend = {
                action: 'submit',
                type: submissionType,
                ...riderData,
                latitude: video.dataset.latitude,
                longitude: video.dataset.longitude,
                address: video.dataset.address,
                selfie: selfie,
            };

            if (submissionType === 'checkin') {
                dataToSend.shiftTime = shiftTimeSelect.value;
            } else {
                dataToSend = { ...dataToSend, ...checkoutDetails };
            }
            
            try {
                const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify(dataToSend),
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.status === 'success') {
                    const successMessage = submissionType === 'checkin' ? 'Check-in successful! Have a great shift.' : 'Check-out successful! Have a good rest.';
                    showMessage('Success', successMessage, () => location.reload());
                } else {
                    showMessage('Submission Failed', result.message || 'An unknown error occurred.', () => showScreen(mainScreen));
                }
            } catch (error) {
                 showMessage('Network Error', 'Could not submit data. Please check your internet connection and try again.', () => showScreen(mainScreen));
            }
        }
        
        // --- Utility Functions ---
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // metres
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // in metres
        }
        
        async function getReverseGeocode(lat, lon) {
            try {
                // Using a free, no-key-required reverse geocoding service
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                const data = await response.json();
                return data.display_name || `${lat}, ${lon}`;
            } catch (error) {
                console.error("Reverse geocoding failed:", error);
                return `${lat}, ${lon}`; // Fallback to coordinates
            }
        }
        
        // --- Gemini API Functions ---
        async function getDailyTip() {
            geminiTipCard.classList.remove('hidden');
            geminiTip.textContent = "Soch raha hoon...";
            
            const prompt = "Act as a friendly manager for delivery riders in India. Provide one short, motivational, and practical safety tip for their day. Keep it under 20 words. For example: 'Hydrated raho, safe chalo. Aap best ho!' or 'Double-check your mirrors before every turn. Ride safe!'";
            
            try {
                 const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=YOUR_API_KEY_HERE`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                 });
                 const result = await response.json();
                 const tip = result.candidates[0].content.parts[0].text;
                 geminiTip.textContent = tip.trim();
            } catch(e) {
                geminiTip.textContent = "Stay alert, ride safe. Have a great day!";
            }
        }

        async function getShiftSummary() {
            const kms = document.getElementById('totalKms').value;
            const rides = document.getElementById('totalRides').value;
            
            if(!kms || !rides) {
                showMessage('Details Missing', 'Please enter total KMs and rides to get a summary.');
                return;
            }
            
            geminiSummaryCard.classList.remove('hidden');
            geminiSummary.textContent = "Aapke shift ka summary generate ho raha hai...";
            
             const prompt = `Act as an encouraging manager for a delivery rider in India. The rider completed ${rides} rides and travelled ${kms} KMs. Write a very short, positive, one-sentence summary of their hard work. For example: 'Great work today! ${rides} rides and ${kms} KMs is a solid effort. Rest well!'`;
            
            try {
                 const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=YOUR_API_KEY_HERE`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                 });
                 const result = await response.json();
                 const summary = result.candidates[0].content.parts[0].text;
                 geminiSummary.textContent = summary.trim();
            } catch(e) {
                geminiSummary.textContent = `Excellent work covering ${kms} KMs over ${rides} rides. Well done!`;
            }
        }

    </script>
</body>
</html>

