<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RCIS (Rider Check-In System)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .glass-card {
            background: rgba(28, 28, 40, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .btn-grad {
            background-image: linear-gradient(to right, #00c6ff 0%, #0072ff 51%, #00c6ff 100%);
            transition: 0.5s;
            background-size: 200% auto;
            box-shadow: 0 0 20px #0072ff50;
        }
        .btn-grad:hover:not(:disabled) {
            background-position: right center;
        }
        .btn-grad:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: #00c6ff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .pin-container {
            position: relative;
        }
        .pin-toggle {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #9ca3af;
        }
        .title-text {
            font-size: clamp(1.25rem, 5vw, 1.875rem); /* Responsive font size */
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4">

    <!-- Main Container -->
    <div id="appContainer" class="w-full max-w-md">

        <!-- Login Screen -->
        <div id="loginScreen" class="glass-card p-8 rounded-2xl shadow-2xl">
            <h1 class="title-text font-bold text-center mb-6 bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-cyan-300">RCIS (Rider Check-In System)</h1>
            <div>
                <label for="riderId" class="text-sm font-medium text-gray-300 mb-1 block">Enter Your Rider ID</label>
                <input type="text" id="riderId" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2.5 placeholder-gray-500" placeholder="E.g., FAR001">
            </div>
            <div class="mt-4">
                <label for="secretPin" class="text-sm font-medium text-gray-300 mb-1 block">Enter Your Secret PIN</label>
                <div class="pin-container">
                    <input type="password" id="secretPin" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2.5 placeholder-gray-500" placeholder="••••••">
                    <span id="pinToggle" class="pin-toggle">
                        <svg id="eye-open" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                        <svg id="eye-closed" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><path d="M9.9 4.24A9 9 0 0 1 12 3c7 0 10 7 10 7a13.4 13.4 0 0 1-1.6 2.4M2 12s3-7 10-7c.6 0 1.2.1 1.8.2"/><path d="m2 2 20 20"/><path d="M15.1 18.4A5 5 0 0 1 12 17c-7 0-10-7-10-7a13.7 13.7 0 0 1 4.2-5.4"/></svg>
                    </span>
                </div>
            </div>
            <button id="loginBtn" class="w-full mt-6 btn-grad text-white font-bold py-3 rounded-lg">Login</button>
        </div>

        <!-- Action Screen -->
        <div id="actionScreen" class="hidden glass-card p-8 rounded-2xl shadow-2xl">
            <h2 class="text-xl font-bold text-center">Welcome, <span id="riderNameDisplay"></span>!</h2>
            <p class="text-center text-gray-400 text-sm mb-6" id="riderIdDisplay"></p>
            
            <div id="shiftSelection">
                 <h3 id="shiftTitle" class="font-semibold mb-2 text-center">Select your shift:</h3>
                 <div id="shiftButtons" class="space-y-3">
                     <!-- Shift buttons will be populated here by the script -->
                 </div>
            </div>

            <div id="checkOutSection" class="hidden">
                <h3 class="font-semibold mb-4 text-center">Check-Out Details</h3>
                 <!-- Checkout form fields -->
                 <div class="space-y-3">
                     <input type="number" id="totalRides" placeholder="Total Rides (System)" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2">
                     <input type="number" id="totalKms" placeholder="Total KMs (System)" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2">
                     <input type="number" id="manualOrders" placeholder="Manual Orders" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2">
                     <input type="number" id="manualKms" placeholder="Manual KMs" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2">
                     <select id="lastOrder" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2">
                         <option value="">Last Order?</option>
                         <option value="Yes">Yes</option>
                         <option value="No">No</option>
                     </select>
                     <input type="time" id="lastOrderTime" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2">
                 </div>
                 <button id="confirmCheckOutBtn" class="w-full mt-4 btn-grad text-white font-bold py-3 rounded-lg">Confirm Check-Out</button>
            </div>
             <button id="logoutBtn" class="w-full mt-4 text-gray-400 text-sm">Logout</button>
        </div>
        
        <!-- Geolocation & Camera Screen -->
        <div id="captureScreen" class="hidden glass-card p-8 rounded-2xl shadow-2xl">
            <h2 id="captureTitle" class="text-xl font-bold text-center mb-4"></h2>
            <div id="locationStep">
                <p class="text-center text-gray-300 mb-4">Please grant location access to verify you are at the office.</p>
                <button id="verifyLocationBtn" class="w-full btn-grad text-white font-bold py-3 rounded-lg">Verify My Location</button>
            </div>
            <div id="cameraStep" class="hidden">
                <div class="w-full aspect-square bg-gray-800 rounded-lg mb-4 overflow-hidden">
                    <video id="video" class="w-full h-full object-cover" autoplay playsinline></video>
                </div>
                <canvas id="canvas" class="hidden"></canvas>
                <button id="snap" class="w-full btn-grad text-white font-bold py-3 rounded-lg">Take Selfie & Submit</button>
            </div>
        </div>

    </div>
    
    <!-- Loader -->
    <div id="loader" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="mx-auto loader"></div>
            <p id="loaderText" class="mt-4 text-lg"></p>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="alertModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div class="glass-card w-full max-w-sm p-6 rounded-2xl text-center">
            <h3 id="alertTitle" class="text-lg font-bold mb-2"></h3>
            <p id="alertMessage" class="text-gray-300 mb-6"></p>
            <button id="alertOkBtn" class="w-full btn-grad text-white font-bold py-2.5 rounded-lg">OK</button>
        </div>
    </div>


    <script>
        // --- CONFIGURATION ---
        const APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyUhsEV7GxKRfUfQFKH2REGCXhMxY1QWVaEJd8eSxGBCw4YOglA5mjcPD_Qu4sE5g32Eg/exec';
        const OFFICE_COORDS = { lat: 28.460845, lon: 77.079439 };
        const ALLOWED_RADIUS_METERS = 200;
        const REFRESH_TIMEOUT_MS = 120000; // 2 minutes

        // --- DOM ELEMENTS ---
        const loginScreen = document.getElementById('loginScreen');
        const actionScreen = document.getElementById('actionScreen');
        const captureScreen = document.getElementById('captureScreen');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loaderText');
        const alertModal = document.getElementById('alertModal');
        const alertTitle = document.getElementById('alertTitle');
        const alertMessage = document.getElementById('alertMessage');
        const alertOkBtn = document.getElementById('alertOkBtn');
        const loginBtn = document.getElementById('loginBtn');
        const pinToggle = document.getElementById('pinToggle');

        // --- STATE ---
        let riderData = null;
        let submissionType = ''; // 'checkin' or 'checkout'
        let selectedShift = '';
        let currentCoords = null;
        let refreshTimer = null;

        // --- EVENT LISTENERS ---
        loginBtn.addEventListener('click', handleLogin);
        alertOkBtn.addEventListener('click', () => hideElement(alertModal));
        pinToggle.addEventListener('click', togglePinVisibility);
        document.getElementById('logoutBtn').addEventListener('click', logout);
        document.getElementById('verifyLocationBtn').addEventListener('click', verifyLocation);
        document.getElementById('snap').addEventListener('click', snapAndSubmit);


        // --- UI FUNCTIONS ---
        function showLoader(text) {
            loaderText.textContent = text;
            showElement(loader);
        }

        function hideLoader() {
            hideElement(loader);
        }
        
        function showAlert(title, message) {
            hideLoader();
            alertTitle.textContent = title;
            alertMessage.textContent = message;
            showElement(alertModal);
        }
        
        function showElement(el) { el.classList.remove('hidden'); }
        function hideElement(el) { el.classList.add('hidden'); }

        function togglePinVisibility() {
            const pinInput = document.getElementById('secretPin');
            const eyeOpen = document.getElementById('eye-open');
            const eyeClosed = document.getElementById('eye-closed');
            if (pinInput.type === 'password') {
                pinInput.type = 'text';
                hideElement(eyeOpen);
                showElement(eyeClosed);
            } else {
                pinInput.type = 'password';
                showElement(eyeOpen);
                hideElement(eyeClosed);
            }
        }
        
        // --- CORE LOGIC ---
        async function handleLogin() {
            const riderId = document.getElementById('riderId').value.trim().toUpperCase();
            const secretPin = document.getElementById('secretPin').value.trim();
            if (!riderId || !secretPin) {
                return showAlert('Input Required', 'Please enter both Rider ID and Secret PIN.');
            }
            showLoader('Logging in...');
            try {
                const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'login', riderId, secretPin }),
                    headers: { 'Content-Type': 'application/json' },
                });

                if (!response.ok) {
                   throw new Error(`Server responded with status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.status === 'success' && result.data) {
                    riderData = result.data;
                    setupActionScreen();
                } else {
                    throw new Error(result.message || 'An unknown error occurred.');
                }
            } catch (error) {
                console.error('Login Fetch Error:', error);
                showAlert('Error', 'An error occurred. Please check your connection and try again.');
            } finally {
                hideLoader();
            }
        }
        
        // --- ACTION SCREEN SETUP (ROBUST VERSION) ---
        function setupActionScreen() {
            try {
                if (!riderData || !riderData.riderName) {
                    showAlert('Data Error', 'Rider data could not be loaded correctly. Please try logging in again.');
                    logout();
                    return;
                }

                document.getElementById('riderNameDisplay').textContent = riderData.riderName;
                document.getElementById('riderIdDisplay').textContent = riderData.riderId || 'N/A';

                const shiftSelection = document.getElementById('shiftSelection');
                const checkOutSection = document.getElementById('checkOutSection');
                const shiftButtonsContainer = document.getElementById('shiftButtons');
                const shiftTitle = document.getElementById('shiftTitle');

                // Defensive defaults to prevent errors from bad data
                const checkedInShifts = Array.isArray(riderData.checkedInShifts) ? riderData.checkedInShifts : [];
                const checkInCountToday = typeof riderData.checkInCountToday === 'number' ? riderData.checkInCountToday : 0;
                const hasCheckedIn = typeof riderData.hasCheckedIn === 'boolean' ? riderData.hasCheckedIn : false;

                const allShifts = ["8 AM to 6 PM", "4 PM to 2 AM", "10 PM to 8 AM"];
                const availableShifts = allShifts.filter(s => !checkedInShifts.includes(s));
                
                shiftButtonsContainer.innerHTML = '';
                showElement(shiftSelection);
                
                if (checkInCountToday < 2 && availableShifts.length > 0) {
                     availableShifts.forEach(shift => {
                        const button = document.createElement('button');
                        button.textContent = `Check-In for ${shift}`;
                        button.className = 'w-full btn-grad text-white font-bold py-3 rounded-lg';
                        button.onclick = () => startCapture('checkin', shift);
                        shiftButtonsContainer.appendChild(button);
                    });
                    showElement(shiftTitle);
                } else {
                     shiftButtonsContainer.innerHTML = '<p class="text-center text-yellow-400 py-4">You have already completed the maximum shifts for today.</p>';
                     hideElement(shiftTitle);
                }
                
                if (hasCheckedIn) {
                    document.getElementById('confirmCheckOutBtn').onclick = () => startCapture('checkout');
                    showElement(checkOutSection);
                } else {
                    hideElement(checkOutSection);
                }

                hideElement(loginScreen);
                showElement(actionScreen);

            } catch (error) {
                console.error("Error setting up action screen:", error);
                showAlert('Display Error', 'There was an issue displaying your options. Please try logging in again.');
                logout();
            }
        }

        
        function startCapture(type, shift = '') {
            submissionType = type;
            selectedShift = shift;
            document.getElementById('captureTitle').textContent = type === 'checkin' ? 'Confirm Check-In' : 'Confirm Check-Out';
            hideElement(actionScreen);
            showElement(captureScreen);
            showElement(document.getElementById('locationStep'));
            hideElement(document.getElementById('cameraStep'));
        }

        // --- GEOLOCATION & CAMERA ---
        function verifyLocation() {
            showLoader('Verifying location...');
            if (!navigator.geolocation) {
                return showAlert('Error', 'Geolocation is not supported by your browser.');
            }
            navigator.geolocation.getCurrentPosition(
                position => {
                    currentCoords = { lat: position.coords.latitude, lon: position.coords.longitude };
                    const distance = calculateDistance(currentCoords, OFFICE_COORDS);

                    if (distance <= ALLOWED_RADIUS_METERS) {
                        hideLoader();
                        startCamera();
                    } else {
                        hideLoader();
                        showAlert('Location Error', `You are ${distance.toFixed(0)} meters away. Please move closer to the office to proceed.`);
                    }
                },
                () => {
                    showAlert('Error', 'Unable to retrieve your location. Please ensure location services are enabled.');
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }
        
        function calculateDistance(coords1, coords2) {
            const R = 6371e3; // metres
            const φ1 = coords1.lat * Math.PI / 180;
            const φ2 = coords2.lat * Math.PI / 180;
            const Δφ = (coords2.lat - coords1.lat) * Math.PI / 180;
            const Δλ = (coords2.lon - coords1.lon) * Math.PI / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // in metres
        }
        
        async function startCamera() {
            hideElement(document.getElementById('locationStep'));
            showElement(document.getElementById('cameraStep'));

            refreshTimer = setTimeout(() => {
                stopCamera();
                showAlert('Session Expired', 'Your 2-minute window has expired. Please verify your location again.');
                hideElement(captureScreen);
                showElement(actionScreen);
            }, REFRESH_TIMEOUT_MS);
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                document.getElementById('video').srcObject = stream;
            } catch (err) {
                 clearTimeout(refreshTimer);
                 showAlert('Camera Error', 'Could not access the camera. Please grant camera permissions.');
            }
        }
        
        function stopCamera() {
            const video = document.getElementById('video');
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            video.srcObject = null;
        }

        async function snapAndSubmit() {
            clearTimeout(refreshTimer);
            showLoader('Processing...');
            
            const canvas = document.getElementById('canvas');
            const video = document.getElementById('video');
            const context = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.translate(canvas.width, 0); // Flip horizontally
            context.scale(-1, 1);
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            context.setTransform(1, 0, 0, 1, 0, 0); // Reset transform
            stopCamera();

            const address = await getAddressFromCoords(currentCoords);
            drawTextOnCanvas(context, canvas.width, canvas.height, address);

            const selfieBase64 = canvas.toDataURL('image/jpeg');
            
            const submissionData = {
                action: 'submit',
                type: submissionType,
                ...riderData,
                latitude: currentCoords.lat,
                longitude: currentCoords.lon,
                address: address,
                selfie: selfieBase64,
                shiftTime: selectedShift,
            };

            if (submissionType === 'checkout') {
                submissionData.totalRides = document.getElementById('totalRides').value;
                submissionData.totalKms = document.getElementById('totalKms').value;
                submissionData.manualOrders = document.getElementById('manualOrders').value;
                submissionData.manualKms = document.getElementById('manualKms').value;
                submissionData.lastOrder = document.getElementById('lastOrder').value;
                submissionData.lastOrderTime = document.getElementById('lastOrderTime').value;
            }

            try {
                const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify(submissionData),
                    headers: { 'Content-Type': 'application/json' },
                });

                 if (!response.ok) {
                   throw new Error(`Server responded with status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.status === 'success') {
                    showAlert('Success!', `Your ${submissionType} has been recorded successfully.`);
                    logout();
                } else {
                    showAlert('Submission Failed', result.message || 'An unknown error occurred.');
                }
            } catch (error) {
                console.error('Submit Fetch Error:', error);
                showAlert('Error', 'An error occurred. Please check your connection and try again.');
            } finally {
                hideLoader();
            }
        }

        // --- HELPERS ---
        async function getAddressFromCoords(coords) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${coords.lat}&lon=${coords.lon}`);
                const data = await response.json();
                return data.display_name || 'Address not found';
            } catch (e) {
                return 'Could not fetch address';
            }
        }
        
        function drawTextOnCanvas(context, width, height, address) {
            const timestamp = new Date().toLocaleString('en-IN', { timeZone: "Asia/Kolkata" });
            
            context.font = 'bold 24px Arial';
            context.fillStyle = 'rgba(255, 255, 255, 0.9)';
            context.strokeStyle = 'black';
            context.lineWidth = 4;
            
            // Simple text wrapping for address
            const maxWidth = width - 40;
            const words = address.split(' ');
            let line = '';
            let y = 40; 
            for(let n = 0; n < words.length; n++) {
                let testLine = line + words[n] + ' ';
                let metrics = context.measureText(testLine);
                if (metrics.width > maxWidth && n > 0) {
                    context.strokeText(line, 20, y);
                    context.fillText(line, 20, y);
                    line = words[n] + ' ';
                    y += 30; // Line height
                } else { line = testLine; }
            }
            context.strokeText(line, 20, y);
            context.fillText(line, 20, y);

            // Timestamp at the bottom
            context.font = 'bold 20px Arial';
            context.strokeText(timestamp, 20, height - 20);
            context.fillText(timestamp, 20, height - 20);
        }

        function logout() {
            riderData = null;
            submissionType = '';
            selectedShift = '';
            currentCoords = null;
            document.getElementById('riderId').value = '';
            document.getElementById('secretPin').value = '';
            hideElement(actionScreen);
            hideElement(captureScreen);
            showElement(loginScreen);
        }

    </script>
</body>
</html>

