<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RCIS (Rider Check-In System)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .glass-card {
            background: rgba(28, 28, 40, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-grad {
            background-image: linear-gradient(to right, #00c6ff 0%, #0072ff 51%, #00c6ff 100%);
            transition: 0.5s;
            background-size: 200% auto;
            box-shadow: 0 0 20px #0072ff50;
        }

        .btn-grad:hover {
            background-position: right center;
        }
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: #00c6ff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        video {
             transform: scaleX(-1); /* Mirror effect */
        }
        canvas {
            display: none;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4">

    <main class="w-full max-w-md">
        <div class="glass-card p-8 rounded-2xl shadow-2xl">

            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-2xl md:text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-cyan-300 whitespace-nowrap">RCIS (Rider Check-In System)</h1>
            </div>

            <!-- Login Page -->
            <div id="loginPage">
                <div class="space-y-6">
                    <div>
                        <label for="riderId" class="block text-sm font-medium text-gray-300 mb-2">Enter Your Rider ID</label>
                        <input type="text" id="riderId" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="E.g., FAR001">
                    </div>
                    <div class="relative">
                        <label for="secretPin" class="block text-sm font-medium text-gray-300 mb-2">Enter Your Secret PIN</label>
                        <input type="password" id="secretPin" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="••••••">
                         <button id="togglePin" type="button" class="absolute inset-y-0 right-0 top-7 pr-3 flex items-center text-gray-400">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <button id="loginBtn" class="w-full btn-grad text-white font-bold py-3 rounded-lg">Login</button>
                </div>
            </div>

            <!-- Main App Page -->
            <div id="appPage" class="hidden">
                 <div class="text-center">
                    <h2 class="text-xl font-bold">Welcome, <span id="riderNameDisplay"></span>!</h2>
                    <p class="text-gray-400 text-sm mb-4" id="riderIdDisplay"></p>
                    
                    <!-- Gemini Tip -->
                    <div id="geminiTip" class="my-4 p-4 bg-gray-800 rounded-lg text-sm text-cyan-300 border border-cyan-500/30">
                        Loading today's tip...
                    </div>

                    <div class="space-y-4">
                        <button id="checkInBtn" class="w-full bg-green-500 hover:bg-green-600 font-semibold py-3 rounded-lg">Check-In</button>
                        <button id="checkOutBtn" class="w-full bg-red-500 hover:bg-red-600 font-semibold py-3 rounded-lg">Check-Out</button>
                    </div>
                 </div>
            </div>
            
            <!-- Shift Selection Modal -->
            <div id="shiftModal" class="hidden">
                 <h3 class="text-lg font-bold text-center mb-4">Select Your Shift</h3>
                 <div class="space-y-3" id="shiftOptions">
                     <!-- Shift options will be populated here -->
                 </div>
                 <button id="cancelShift" class="w-full mt-4 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
            </div>


            <!-- Geolocation and Camera Page -->
            <div id="capturePage" class="hidden">
                <div class="text-center">
                    <p id="captureStatus" class="mb-4">Getting your location...</p>
                    <video id="video" autoplay playsinline class="w-full rounded-lg mb-4"></video>
                    <canvas id="canvas"></canvas>
                    <button id="captureBtn" class="w-full btn-grad text-white font-bold py-3 rounded-lg hidden">Take Selfie</button>
                    <button id="cancelCapture" class="w-full mt-2 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                </div>
            </div>

            <!-- Checkout Form Page -->
            <div id="checkoutFormPage" class="hidden">
                <h3 class="text-lg font-bold text-center mb-4">Enter Your Trip Details</h3>
                <div class="space-y-4">
                     <input type="number" id="totalRides" placeholder="Total Rides (System)" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3">
                     <input type="number" id="totalKms" placeholder="Total KMs (System)" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3">
                     <input type="number" id="manualOrders" placeholder="Manual Orders" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3">
                     <input type="number" id="manualKms" placeholder="Manual KMs" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3">
                     <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Was this your last order?</label>
                        <select id="lastOrder" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3">
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                     </div>
                     <input type="time" id="lastOrderTime" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3">
                     
                     <div class="flex space-x-2">
                        <button id="getSummaryBtn" class="w-1/2 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 rounded-lg">✨ Get Summary</button>
                        <button id="submitCheckoutBtn" class="w-1/2 btn-grad text-white font-bold py-3 rounded-lg">Submit</button>
                     </div>
                     <p id="geminiSummary" class="text-sm text-gray-400 mt-2 text-center"></p>
                </div>
            </div>

            <!-- Message Modal -->
            <div id="messageModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
                 <div class="glass-card p-8 rounded-2xl shadow-2xl text-center w-80">
                     <h3 id="messageTitle" class="text-xl font-bold mb-4"></h3>
                     <p id="messageText" class="mb-6"></p>
                     <button id="messageOkBtn" class="btn-grad text-white font-bold py-2 px-8 rounded-lg">OK</button>
                 </div>
            </div>
            
             <!-- Loader -->
            <div id="loader" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
                <div class="text-center">
                    <div class="mx-auto loader"></div>
                    <p id="loaderText" class="mt-4 text-lg"></p>
                </div>
            </div>

        </div>
    </main>

    <script>
        // --- CONFIGURATION ---
        const APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyUhsEV7GxKRfUfQFKH2REGCXhMxY1QWVaEJd8eSxGBCw4YOglA5mjcPD_Qu4sE5g32Eg/exec';
        const OFFICE_COORDINATES = { lat: 28.460845, lon: 77.079439 };
        const ALLOWED_RADIUS_METERS = 200;
        const REFRESH_TIMEOUT_MS = 2 * 60 * 1000; // 2 minutes

        // --- DOM ELEMENTS ---
        const loginPage = document.getElementById('loginPage');
        const appPage = document.getElementById('appPage');
        const capturePage = document.getElementById('capturePage');
        const checkoutFormPage = document.getElementById('checkoutFormPage');
        const shiftModal = document.getElementById('shiftModal');

        const loginBtn = document.getElementById('loginBtn');
        const checkInBtn = document.getElementById('checkInBtn');
        const checkOutBtn = document.getElementById('checkOutBtn');
        const captureBtn = document.getElementById('captureBtn');
        const submitCheckoutBtn = document.getElementById('submitCheckoutBtn');
        const cancelCapture = document.getElementById('cancelCapture');
        const cancelShift = document.getElementById('cancelShift');
        const getSummaryBtn = document.getElementById('getSummaryBtn');

        const messageModal = document.getElementById('messageModal');
        const messageTitle = document.getElementById('messageTitle');
        const messageText = document.getElementById('messageText');
        const messageOkBtn = document.getElementById('messageOkBtn');
        
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loaderText');

        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const captureStatus = document.getElementById('captureStatus');

        const riderIdInput = document.getElementById('riderId');
        const secretPinInput = document.getElementById('secretPin');
        const togglePinBtn = document.getElementById('togglePin');
        
        let stream;
        let refreshTimer;
        let currentAction = '';
        let selectedShift = '';
        let userLocation = {};
        let riderData = {};

        // --- EVENT LISTENERS ---
        loginBtn.addEventListener('click', handleLogin);
        checkInBtn.addEventListener('click', () => startCapture('checkin'));
        checkOutBtn.addEventListener('click', () => startCapture('checkout'));
        captureBtn.addEventListener('click', handleCapture);
        submitCheckoutBtn.addEventListener('click', handleSubmitCheckout);
        getSummaryBtn.addEventListener('click', getGeminiSummary);
        cancelCapture.addEventListener('click', goBackToApp);
        cancelShift.addEventListener('click', () => {
             shiftModal.classList.add('hidden');
             appPage.classList.remove('hidden');
        });
        messageOkBtn.addEventListener('click', () => messageModal.classList.add('hidden'));

        togglePinBtn.addEventListener('click', () => {
            const icon = togglePinBtn.querySelector('i');
            if (secretPinInput.type === 'password') {
                secretPinInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                secretPinInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });


        // --- CORE FUNCTIONS ---

        async function handleLogin() {
            const riderId = riderIdInput.value.trim();
            const secretPin = secretPinInput.value.trim();

            if (!riderId || !secretPin) {
                showMessage('Login Failed', 'Please enter both Rider ID and PIN.');
                return;
            }
            showLoader('Logging in...');
            
            try {
                const response = await apiCall({ action: 'login', riderId, secretPin });
                riderData = response.data;
                document.getElementById('riderNameDisplay').textContent = riderData.riderName;
                document.getElementById('riderIdDisplay').textContent = riderData.riderId;
                
                updateUIForRider();
                
                loginPage.classList.add('hidden');
                appPage.classList.remove('hidden');
                getGeminiTip();
            } catch (error) {
                 showMessage('Error', error.message || 'An error occurred. Please check your connection.');
            } finally {
                hideLoader();
            }
        }

        function updateUIForRider() {
            const { checkInCountToday, checkedInShifts, hasCheckedIn } = riderData;
            
            // Logic for Check-in button
            if (checkInCountToday >= 2) {
                checkInBtn.disabled = true;
                checkInBtn.textContent = 'Both shifts completed for today';
                checkInBtn.classList.replace('bg-green-500', 'bg-gray-500');
            } else {
                 checkInBtn.disabled = false;
                 checkInBtn.textContent = 'Check-In';
                 checkInBtn.classList.replace('bg-gray-500', 'bg-green-500');
            }
            
            // Logic for Check-out button
            if (hasCheckedIn) {
                checkOutBtn.disabled = false;
                checkOutBtn.classList.replace('bg-gray-500', 'bg-red-500');
            } else {
                checkOutBtn.disabled = true;
                checkOutBtn.classList.replace('bg-red-500', 'bg-gray-500');
            }
        }


        function startCapture(action) {
            currentAction = action;
            if (action === 'checkin') {
                // Show shift selection modal
                showShiftModal();
            } else { // checkout
                proceedToGeolocation();
            }
        }

        function showShiftModal() {
            const allShifts = ["8 AM to 6 PM", "4 PM to 2 AM"];
            const availableShifts = allShifts.filter(shift => !riderData.checkedInShifts.includes(shift));

            const shiftOptionsContainer = document.getElementById('shiftOptions');
            shiftOptionsContainer.innerHTML = ''; // Clear previous options

            if(availableShifts.length === 0) {
                 showMessage("No Shifts Available", "You have already checked-in for all available shifts today.");
                 return;
            }

            availableShifts.forEach(shift => {
                const button = document.createElement('button');
                button.textContent = shift;
                button.className = 'w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg';
                button.onclick = () => {
                    selectedShift = shift;
                    shiftModal.classList.add('hidden');
                    proceedToGeolocation();
                };
                shiftOptionsContainer.appendChild(button);
            });
            
            appPage.classList.add('hidden');
            shiftModal.classList.remove('hidden');
        }


        function proceedToGeolocation() {
            appPage.classList.add('hidden');
            shiftModal.classList.add('hidden');
            capturePage.classList.remove('hidden');
            captureStatus.textContent = 'Getting your location...';
            captureBtn.classList.add('hidden');

            if (!navigator.geolocation) {
                showMessage('Error', 'Geolocation is not supported by your browser.');
                goBackToApp();
                return;
            }
            
            navigator.geolocation.getCurrentPosition(locationSuccess, locationError, { enableHighAccuracy: true });
        }

        function locationSuccess(position) {
            userLocation = {
                lat: position.coords.latitude,
                lon: position.coords.longitude
            };
            const distance = calculateDistance(userLocation, OFFICE_COORDINATES);

            if (distance <= ALLOWED_RADIUS_METERS) {
                captureStatus.textContent = 'Location verified. Please take a selfie.';
                startCamera();
            } else {
                showMessage('Location Error', `You are ${distance.toFixed(0)} meters away. You must be within ${ALLOWED_RADIUS_METERS} meters of the office to proceed.`);
                goBackToApp();
            }
        }

        function locationError(error) {
            showMessage('Location Error', `Could not get your location. Error: ${error.message}`);
            goBackToApp();
        }

        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                video.srcObject = stream;
                captureBtn.classList.remove('hidden');
                // Start the 2-minute refresh timer ONLY after camera starts
                clearTimeout(refreshTimer); // Clear any existing timer
                refreshTimer = setTimeout(() => {
                    showMessage("Session Expired", "You took too long. Please verify your location again.");
                    goBackToApp(true); // Force full page reload
                }, REFRESH_TIMEOUT_MS);

            } catch (err) {
                showMessage('Camera Error', 'Could not access the camera. Please check permissions.');
                goBackToApp();
            }
        }

        async function handleCapture() {
             // Stop the timer as soon as the selfie is taken
            clearTimeout(refreshTimer);
            
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Flip the context horizontally to un-mirror the image
            context.translate(canvas.width, 0);
            context.scale(-1, 1);
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Reset transform to draw text normally
            context.setTransform(1, 0, 0, 1, 0, 0);

            // Get address from coordinates
            showLoader('Getting address...');
            const address = await getAddressFromCoordinates(userLocation.lat, userLocation.lon);
            hideLoader();

            // Add overlay text
            const timestamp = new Date().toLocaleString('en-IN', { timeZone: "Asia/Kolkata" });
            context.fillStyle = 'white';
            context.font = 'bold 24px Arial';
            context.textAlign = 'left';
            context.textBaseline = 'bottom';
            context.fillText(timestamp, 20, canvas.height - 50);
            context.fillText(address, 20, canvas.height - 20);

            const selfie = canvas.toDataURL('image/jpeg');
            stopCamera();

            if (currentAction === 'checkin') {
                submitData({ selfie, address });
            } else { // checkout
                riderData.selfie = selfie;
                riderData.address = address;
                capturePage.classList.add('hidden');
                checkoutFormPage.classList.remove('hidden');
            }
        }
        
        async function handleSubmitCheckout() {
             const checkoutData = {
                totalRides: document.getElementById('totalRides').value,
                totalKms: document.getElementById('totalKms').value,
                manualOrders: document.getElementById('manualOrders').value,
                manualKms: document.getElementById('manualKms').value,
                lastOrder: document.getElementById('lastOrder').value,
                lastOrderTime: document.getElementById('lastOrderTime').value,
                selfie: riderData.selfie,
                address: riderData.address
            };
            submitData(checkoutData);
        }

        async function submitData(extraData = {}) {
            showLoader(currentAction === 'checkin' ? 'Checking in...' : 'Checking out...');
            
            const payload = {
                action: 'submit',
                type: currentAction,
                riderId: riderData.riderId,
                riderName: riderData.riderName,
                riderEmail: riderData.riderEmail,
                latitude: userLocation.lat,
                longitude: userLocation.lon,
                ...extraData
            };
            if(currentAction === 'checkin') {
                payload.shiftTime = selectedShift;
            }

            try {
                const response = await apiCall(payload);
                showMessage('Success', `You have successfully completed ${currentAction}.`);
                goBackToApp(true); // Force reload to update status
            } catch (error) {
                showMessage('Error', error.message || 'An error occurred. Please check your connection.');
                 goBackToApp();
            } finally {
                hideLoader();
            }
        }
        
        // --- GEMINI FUNCTIONS ---
        async function getGeminiTip() {
            try {
                const response = await apiCall({ action: 'gemini', prompt: `Give a one-line motivational or safety tip for a delivery rider named ${riderData.riderName} who is starting their day.` });
                document.getElementById('geminiTip').textContent = response.text;
            } catch(e) {
                console.error("Gemini Tip Error:", e);
                document.getElementById('geminiTip').textContent = "Tip of the day: Ride safely!";
            }
        }
        
        async function getGeminiSummary() {
             const rides = document.getElementById('totalRides').value;
             const kms = document.getElementById('totalKms').value;
             if(!rides || !kms) {
                showMessage("Info", "Please enter Total Rides and KMs first.");
                return;
             }
             const summaryP = document.getElementById('geminiSummary');
             summaryP.textContent = 'Generating summary...';
             
             try {
                const response = await apiCall({ action: 'gemini', rides, kms, prompt: `Create a very short, positive, one-sentence summary for a rider who finished their shift with ${rides} rides and ${kms} KMs.` });
                summaryP.textContent = response.text;
             } catch(e) {
                 console.error("Gemini Summary Error:", e);
                 summaryP.textContent = 'Could not generate summary.';
             }
        }


        // --- UTILITY FUNCTIONS ---

        function goBackToApp(forceReload = false) {
            stopCamera();
            clearTimeout(refreshTimer);
            if (forceReload) {
                window.location.reload();
            } else {
                capturePage.classList.add('hidden');
                checkoutFormPage.classList.add('hidden');
                shiftModal.classList.add('hidden');
                appPage.classList.remove('hidden');
                updateUIForRider();
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            video.srcObject = null;
        }

        function showMessage(title, text) {
            messageTitle.textContent = title;
            messageText.textContent = text;
            messageModal.classList.remove('hidden');
        }

        function showLoader(text) {
            loaderText.textContent = text;
            loader.classList.remove('hidden');
        }

        function hideLoader() {
            loader.classList.add('hidden');
        }

        async function apiCall(body, timeout = 20000) { // Timeout 20 seconds
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);

            try {
                const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify(body),
                    headers: { 'Content-Type': 'application/json' },
                    signal: controller.signal,
                    mode: 'cors' // Added for clarity, though default for cross-origin
                });

                clearTimeout(id);

                if (!response.ok) {
                    throw new Error(`Server error (status: ${response.status}). Please try again.`);
                }
                
                const result = await response.json();
                
                if (result.status === 'error') {
                    throw new Error(result.message || 'An unknown server error occurred.');
                }

                return result;

            } catch (error) {
                clearTimeout(id);
                if (error.name === 'AbortError') {
                    throw new Error('Request timed out. Please check your internet connection and try again.');
                }
                // Re-throw other errors to be caught by the calling function
                throw error;
            }
        }

        function calculateDistance(coords1, coords2) {
            const R = 6371e3; // metres
            const φ1 = coords1.lat * Math.PI / 180;
            const φ2 = coords2.lat * Math.PI / 180;
            const Δφ = (coords2.lat - coords1.lat) * Math.PI / 180;
            const Δλ = (coords2.lon - coords1.lon) * Math.PI / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // in metres
        }
        
        async function getAddressFromCoordinates(lat, lon) {
            try {
                // Using a free, open-source reverse geocoding API
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                const data = await response.json();
                return data.display_name ? data.display_name.split(',').slice(0, 2).join(',') : 'Address not found';
            } catch(e) {
                return 'Could not fetch address';
            }
        }

    </script>
</body>
</html>

