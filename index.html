<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>RCIS (Rider Check-In System)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .btn-grad {
            background-image: linear-gradient(to right, #00c6ff 0%, #0072ff 51%, #00c6ff 100%);
            transition: 0.5s;
            background-size: 200% auto;
            box-shadow: 0 0 20px #0072ff50;
        }

        .btn-grad:hover {
            background-position: right center;
        }

        .loader {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: #00c6ff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        .modal-bg {
            background-color: rgba(0,0,0,0.7);
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div id="app" class="w-full max-w-md mx-auto">
        <!-- Login Screen -->
        <div id="login-screen" class="glass-card p-8 rounded-2xl shadow-lg space-y-6">
            <h1 class="text-2xl md:text-3xl font-bold text-center bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-cyan-300 whitespace-nowrap">RCIS (Rider Check-In System)</h1>
            <div>
                <label for="riderId" class="block text-sm font-medium text-gray-300 mb-2">Enter Your Rider ID</label>
                <input type="text" id="riderId" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="E.g., FAR001">
            </div>
            <div>
                <label for="secretPin" class="block text-sm font-medium text-gray-300 mb-2">Enter Your Secret PIN</label>
                <div class="relative">
                    <input type="password" id="secretPin" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-4 py-3 pr-10 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="••••••">
                    <button id="togglePin" type="button" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>
            <button id="login-btn" class="w-full btn-grad text-white font-bold py-3 px-4 rounded-lg">Login</button>
        </div>

        <!-- Main Screen -->
        <div id="main-screen" class="hidden glass-card p-8 rounded-2xl shadow-lg space-y-6">
            <h2 class="text-2xl font-bold text-center">Welcome, <span id="rider-name" class="bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-cyan-300"></span>!</h2>
            <div id="gemini-tip" class="text-center p-4 bg-gray-800 rounded-lg border border-gray-700 italic">Loading today's tip...</div>
            
            <!-- Shift Selection -->
            <div id="shift-selection" class="hidden space-y-4">
                 <p class="text-center">Select your shift to Check-In:</p>
                 <select id="shift-time" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    <option value="8 AM to 5 PM">8 AM to 5 PM</option>
                    <option value="6 PM to 2 AM">6 PM to 2 AM</option>
                 </select>
                 <button id="checkin-btn" class="w-full btn-grad text-white font-bold py-3 px-4 rounded-lg">Proceed to Check-In</button>
            </div>

             <!-- Check-out form -->
            <div id="checkout-form" class="hidden space-y-4">
                 <p class="text-center font-semibold text-lg">Enter Your Check-Out Details</p>
                 <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="totalRides" placeholder="Total Rides" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2">
                    <input type="number" id="totalKms" placeholder="System KMs" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2">
                    <input type="number" id="manualOrders" placeholder="Manual Orders" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2">
                    <input type="number" id="manualKms" placeholder="Manual KMs" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2">
                 </div>
                 <select id="lastOrder" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3">
                    <option value="Yes">Last Order Picked Up?</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                </select>
                 <input type="time" id="lastOrderTime" placeholder="Last Order Pick-up Time" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2">
                 
                 <button id="get-summary-btn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-2 px-4 rounded-lg">✨ Get Shift Summary</button>
                 <div id="gemini-summary" class="hidden text-center p-3 bg-gray-800 rounded-lg border border-gray-700"></div>

                 <button id="checkout-btn" class="w-full btn-grad text-white font-bold py-3 px-4 rounded-lg">Proceed to Check-Out</button>
            </div>
             <p id="all-shifts-done" class="hidden text-center text-green-400 font-semibold p-4 bg-green-900/50 rounded-lg">You have completed all shifts for today. Thank you!</p>

            <button id="logout-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg mt-4">Logout</button>
        </div>

        <!-- Verification Screen -->
        <div id="verification-screen" class="hidden glass-card p-8 rounded-2xl shadow-lg space-y-4 text-center">
            <h2 id="verification-title" class="text-2xl font-bold">Verification</h2>
            <p id="verification-step" class="text-gray-300">Step 1 of 2: Verifying your location...</p>
            <div id="location-loader" class="mx-auto loader"></div>
            <p id="location-status" class="hidden"></p>

            <div id="camera-container" class="hidden relative w-full aspect-square bg-gray-800 rounded-lg overflow-hidden">
                <video id="video" class="w-full h-full object-cover" autoplay playsinline></video>
                <canvas id="canvas" class="hidden"></canvas>
            </div>
            <button id="capture-btn" class="hidden w-full btn-grad text-white font-bold py-3 px-4 rounded-lg">Capture Selfie</button>
             <button id="cancel-verification" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg mt-2">Cancel</button>
        </div>

        <!-- Modal -->
        <div id="modal" class="hidden fixed inset-0 modal-bg flex items-center justify-center p-4">
            <div class="glass-card p-6 rounded-2xl shadow-xl w-full max-w-sm text-center">
                <h3 id="modal-title" class="text-xl font-bold mb-2"></h3>
                <p id="modal-message" class="text-gray-300 mb-6"></p>
                <button id="modal-ok-btn" class="btn-grad text-white font-bold py-2 px-6 rounded-lg">OK</button>
            </div>
        </div>

         <!-- Fullscreen Loader -->
        <div id="fullscreen-loader" class="hidden fixed inset-0 modal-bg flex flex-col items-center justify-center">
            <div class="loader"></div>
            <p id="loader-message" class="mt-4 text-lg">Please wait...</p>
        </div>
    </div>

    <script>
        const APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyUhsEV7GxKRfUfQFKH2REGCXhMxY1QWVaEJd8eSxGBCw4YOglA5mjcPD_Qu4sE5g32Eg/exec';

        // Office Coordinates
        const OFFICE_LAT = 28.460845;
        const OFFICE_LON = 77.079439;
        const ALLOWED_RADIUS_METERS = 200;
        const REFRESH_TIMEOUT = 120000; // 2 minutes

        // DOM Elements
        const loginScreen = document.getElementById('login-screen');
        const mainScreen = document.getElementById('main-screen');
        const verificationScreen = document.getElementById('verification-screen');
        const riderNameSpan = document.getElementById('rider-name');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const riderIdInput = document.getElementById('riderId');
        const secretPinInput = document.getElementById('secretPin');
        const togglePinBtn = document.getElementById('togglePin');
        
        const checkinBtn = document.getElementById('checkin-btn');
        const checkoutBtn = document.getElementById('checkout-btn');
        const shiftSelectionDiv = document.getElementById('shift-selection');
        const checkoutFormDiv = document.getElementById('checkout-form');
        const allShiftsDoneP = document.getElementById('all-shifts-done');
        const shiftTimeSelect = document.getElementById('shift-time');

        const verificationTitle = document.getElementById('verification-title');
        const verificationStep = document.getElementById('verification-step');
        const locationLoader = document.getElementById('location-loader');
        const locationStatus = document.getElementById('location-status');
        const cameraContainer = document.getElementById('camera-container');
        const captureBtn = document.getElementById('capture-btn');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const cancelVerificationBtn = document.getElementById('cancel-verification');

        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalOkBtn = document.getElementById('modal-ok-btn');
        
        const fullscreenLoader = document.getElementById('fullscreen-loader');
        const loaderMessage = document.getElementById('loader-message');

        const geminiTipDiv = document.getElementById('gemini-tip');
        const getSummaryBtn = document.getElementById('get-summary-btn');
        const geminiSummaryDiv = document.getElementById('gemini-summary');
        
        let currentRider = null;
        let verificationType = ''; // 'checkin' or 'checkout'
        let verificationTimer = null;

        // --- Event Listeners ---
        loginBtn.addEventListener('click', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);
        checkinBtn.addEventListener('click', () => startVerification('checkin'));
        checkoutBtn.addEventListener('click', () => startVerification('checkout'));
        captureBtn.addEventListener('click', handleCapture);
        modalOkBtn.addEventListener('click', () => modal.classList.add('hidden'));
        cancelVerificationBtn.addEventListener('click', cancelVerification);
        togglePinBtn.addEventListener('click', togglePinVisibility);
        getSummaryBtn.addEventListener('click', getShiftSummary);


        // --- Functions ---
        
        function showLoader(message = 'Please wait...') {
            loaderMessage.textContent = message;
            fullscreenLoader.classList.remove('hidden');
        }

        function hideLoader() {
            fullscreenLoader.classList.add('hidden');
        }
        
        function showModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
        }

        function togglePinVisibility() {
            const icon = togglePinBtn.querySelector('i');
            if (secretPinInput.type === 'password') {
                secretPinInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                secretPinInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        async function handleLogin() {
            const riderId = riderIdInput.value.trim();
            const secretPin = secretPinInput.value.trim();

            if (!riderId || !secretPin) {
                showModal('Error', 'Please enter both Rider ID and Secret PIN.');
                return;
            }

            showLoader('Logging in...');
            try {
                const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'login', riderId, secretPin }),
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    currentRider = result.data;
                    localStorage.setItem('currentRider', JSON.stringify(currentRider));
                    updateUIForLoggedInUser();
                    loginScreen.classList.add('hidden');
                    mainScreen.classList.remove('hidden');
                    fetchGeminiTip();
                } else {
                    showModal('Login Failed', result.message);
                }
            } catch (error) {
                showModal('Error', 'An error occurred. Please check your connection.');
            } finally {
                hideLoader();
            }
        }

        function updateUIForLoggedInUser() {
            if (!currentRider) return;
            
            riderNameSpan.textContent = currentRider.riderName;

            // Hide all action sections initially
            shiftSelectionDiv.classList.add('hidden');
            checkoutFormDiv.classList.add('hidden');
            allShiftsDoneP.classList.add('hidden');

            if (currentRider.checkInCountToday >= 2) {
                allShiftsDoneP.classList.remove('hidden');
            } else if (currentRider.hasCheckedIn && currentRider.checkInCountToday === 1) {
                // If one shift is done, show checkout form
                checkoutFormDiv.classList.remove('hidden');
                 // Check if the other shift is available.
                const allShifts = ["8 AM to 5 PM", "6 PM to 2 AM"];
                const availableShifts = allShifts.filter(s => !currentRider.checkedInShifts.includes(s));
                if (availableShifts.length > 0) {
                     shiftSelectionDiv.classList.remove('hidden');
                     shiftTimeSelect.innerHTML = availableShifts.map(s => `<option value="${s}">${s}</option>`).join('');
                } else {
                     shiftSelectionDiv.classList.add('hidden');
                }

            } else if (!currentRider.hasCheckedIn) {
                 shiftSelectionDiv.classList.remove('hidden');
                 shiftTimeSelect.innerHTML = `
                    <option value="8 AM to 5 PM">8 AM to 5 PM</option>
                    <option value="6 PM to 2 AM">6 PM to 2 AM</option>
                 `;
            }
        }


        function handleLogout() {
            currentRider = null;
            localStorage.removeItem('currentRider');
            mainScreen.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            riderIdInput.value = '';
            secretPinInput.value = '';
        }

        function startVerification(type) {
            verificationType = type;
            mainScreen.classList.add('hidden');
            verificationScreen.classList.remove('hidden');
            verificationTitle.textContent = type === 'checkin' ? 'Check-In Verification' : 'Check-Out Verification';
            resetVerificationUI();
            checkLocation();
        }

        function resetVerificationUI() {
            verificationStep.textContent = 'Step 1 of 2: Verifying your location...';
            locationLoader.classList.remove('hidden');
            locationStatus.classList.add('hidden');
            cameraContainer.classList.add('hidden');
            captureBtn.classList.add('hidden');
            stopCamera();
            if (verificationTimer) clearTimeout(verificationTimer);
        }

        function cancelVerification() {
             verificationScreen.classList.add('hidden');
             mainScreen.classList.remove('hidden');
             resetVerificationUI();
        }

        function checkLocation() {
            if (!navigator.geolocation) {
                locationError('Geolocation is not supported by your browser.');
                return;
            }

            navigator.geolocation.getCurrentPosition(locationSuccess, 
                () => locationError('Unable to retrieve your location. Please enable location services.'),
                { enableHighAccuracy: true }
            );
        }

        function locationSuccess(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const distance = getDistanceFromLatLonInMeters(lat, lon, OFFICE_LAT, OFFICE_LON);

            if (distance <= ALLOWED_RADIUS_METERS) {
                locationStatus.textContent = 'Location verified successfully!';
                locationStatus.classList.remove('hidden', 'text-red-400');
                locationStatus.classList.add('text-green-400');
                locationLoader.classList.add('hidden');
                
                currentRider.latitude = lat;
                currentRider.longitude = lon;

                proceedToCamera();
                verificationTimer = setTimeout(() => {
                    showModal('Session Expired', 'Your 2-minute verification window has expired. Please verify your location again.');
                    cancelVerification();
                }, REFRESH_TIMEOUT);

            } else {
                locationError(`You are ${Math.round(distance)} meters away. You must be within ${ALLOWED_RADIUS_METERS} meters of the office.`);
            }
        }

        function locationError(message) {
            locationStatus.textContent = message;
            locationStatus.classList.remove('hidden', 'text-green-400');
            locationStatus.classList.add('text-red-400');
            locationLoader.classList.add('hidden');
        }

        async function proceedToCamera() {
            verificationStep.textContent = 'Step 2 of 2: Take a Selfie';
            cameraContainer.classList.remove('hidden');
            captureBtn.classList.remove('hidden');

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                video.srcObject = stream;
            } catch (err) {
                showModal('Camera Error', 'Could not access the camera. Please grant camera permissions.');
                cancelVerification();
            }
        }
        
        function stopCamera() {
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
        }

        async function handleCapture() {
            showLoader('Processing...');
            
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            const address = await getAddressFromCoords(currentRider.latitude, currentRider.longitude);
            currentRider.address = address;

            drawTextOnCanvas(context, address, new Date().toLocaleString('en-IN'));

            const selfie = canvas.toDataURL('image/jpeg');
            
            let dataToSend = {
                action: 'submit',
                type: verificationType,
                riderId: currentRider.riderId,
                riderName: currentRider.riderName,
                riderEmail: currentRider.riderEmail,
                latitude: currentRider.latitude,
                longitude: currentRider.longitude,
                address: currentRider.address,
                selfie: selfie
            };

            if (verificationType === 'checkin') {
                dataToSend.shiftTime = shiftTimeSelect.value;
            } else {
                 dataToSend.totalRides = document.getElementById('totalRides').value;
                 dataToSend.totalKms = document.getElementById('totalKms').value;
                 dataToSend.manualOrders = document.getElementById('manualOrders').value;
                 dataToSend.manualKms = document.getElementById('manualKms').value;
                 dataToSend.lastOrder = document.getElementById('lastOrder').value;
                 dataToSend.lastOrderTime = document.getElementById('lastOrderTime').value;
            }
            
            try {
                 const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify(dataToSend),
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                if(result.status === 'success') {
                    showModal('Success', `You have successfully ${verificationType === 'checkin' ? 'checked-in' : 'checked-out'}!`);
                    // Reset UI and log out to force re-login and get new status
                    handleLogout();
                    riderIdInput.value = dataToSend.riderId;
                } else {
                     showModal('Submission Failed', result.message);
                }

            } catch(error) {
                showModal('Error', 'An error occurred during submission.');
            } finally {
                hideLoader();
                cancelVerification();
            }
        }
        
        function drawTextOnCanvas(context, address, timestamp) {
            const canvasWidth = context.canvas.width;
            const fontSize = canvasWidth / 25;
            context.font = `bold ${fontSize}px sans-serif`;
            context.fillStyle = 'rgba(255, 255, 255, 0.9)';
            context.strokeStyle = 'rgba(0, 0, 0, 0.7)';
            context.lineWidth = fontSize / 10;
            
            const textLines = [timestamp, ...wrapText(context, address, canvasWidth * 0.95)];
            
            textLines.forEach((line, index) => {
                const y = context.canvas.height - (textLines.length - index) * (fontSize * 1.2) - 10;
                context.strokeText(line, 10, y);
                context.fillText(line, 10, y);
            });
        }

        function wrapText(context, text, maxWidth) {
            const words = text.split(' ');
            let lines = [];
            let currentLine = words[0];
            for (let i = 1; i < words.length; i++) {
                const word = words[i];
                const width = context.measureText(currentLine + " " + word).width;
                if (width < maxWidth) {
                    currentLine += " " + word;
                } else {
                    lines.push(currentLine);
                    currentLine = word;
                }
            }
            lines.push(currentLine);
            return lines;
        }

        async function getAddressFromCoords(lat, lon) {
             try {
                // Using a free, no-key reverse geocoding API
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                const data = await response.json();
                return data.display_name || 'Address not found';
            } catch (error) {
                return 'Could not fetch address';
            }
        }


        function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
            var R = 6371; // Radius of the earth in km
            var dLat = deg2rad(lat2 - lat1);
            var dLon = deg2rad(lon2 - lon1);
            var a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            var d = R * c; // Distance in km
            return d * 1000; // Distance in meters
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180)
        }
        
        // --- Gemini Functions ---
        async function fetchGeminiTip() {
            if (!currentRider) return;
            try {
                const prompt = `Create a short, one-sentence motivational or safety tip for a delivery rider named ${currentRider.riderName} who is starting their shift. Keep it concise and positive.`;
                geminiTipDiv.innerHTML = "<em>Generating tip...</em>";
                
                 const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'gemini', prompt: prompt }),
                     headers: { 'Content-Type': 'application/json' }
                });
                 const result = await response.json();

                if (result.status === 'success' && result.text) {
                    geminiTipDiv.textContent = `✨ Today's Tip: ${result.text}`;
                } else {
                    geminiTipDiv.textContent = "✨ Today's Tip: Ride safe and make today count!";
                }

            } catch (error) {
                 geminiTipDiv.textContent = "✨ Today's Tip: Stay focused and have a great shift!";
            }
        }

        async function getShiftSummary() {
            const totalRides = document.getElementById('totalRides').value;
            const totalKms = document.getElementById('totalKms').value;

            if (!totalRides || !totalKms) {
                showModal("Input Needed", "Please enter total rides and KMs to get a summary.");
                return;
            }
            
            const prompt = `A delivery rider, ${currentRider.riderName}, just finished their shift. They completed ${totalRides} rides and travelled ${totalKms} KMs. Write a very short, positive, one-sentence summary acknowledging their hard work.`;
            geminiSummaryDiv.classList.remove('hidden');
            geminiSummaryDiv.innerHTML = "<em>Generating summary...</em>";

            try {
                const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                     method: 'POST',
                    body: JSON.stringify({ action: 'gemini', prompt: prompt }),
                     headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                if(result.status === 'success' && result.text){
                    geminiSummaryDiv.textContent = result.text;
                } else {
                    geminiSummaryDiv.textContent = "Great job on your shift today!";
                }
            } catch (error) {
                geminiSummaryDiv.textContent = "Excellent work completing your shift!";
            }
        }


        // --- Initial Load ---
        function init() {
            const storedRider = localStorage.getItem('currentRider');
            if (storedRider) {
                currentRider = JSON.parse(storedRider);
                updateUIForLoggedInUser();
                loginScreen.classList.add('hidden');
                mainScreen.classList.remove('hidden');
                fetchGeminiTip();
            }
        }

        init();
    </script>
</body>
</html>

