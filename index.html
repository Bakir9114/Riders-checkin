<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rider Check-in System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .hidden {
            display: none;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-lg p-6 md:p-8">

        <!-- Login Section -->
        <div id="login-section">
            <div class="text-center mb-8">
                <h1 class="text-2xl font-bold text-gray-800">Rider Login</h1>
                <p class="text-gray-500">Apna Rider ID aur PIN daalein</p>
            </div>
            <div class="space-y-6">
                <div>
                    <label for="rider-id" class="text-sm font-medium text-gray-700">Rider ID</label>
                    <input type="text" id="rider-id" class="mt-1 w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 uppercase" placeholder="e.g., DL1-R001">
                </div>
                <div>
                    <label for="rider-pin" class="text-sm font-medium text-gray-700">Secret PIN</label>
                    <input type="password" id="rider-pin" class="mt-1 w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="****">
                </div>
                <button id="login-btn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 shadow-md">Login</button>
            </div>
        </div>

        <!-- App Section -->
        <div id="app-section" class="hidden">
            <header class="flex justify-between items-center mb-6 pb-4 border-b">
                <div>
                    <h1 class="text-xl font-bold text-gray-800">Welcome,</h1>
                    <p id="user-name" class="text-lg text-blue-600 font-semibold"></p>
                </div>
                <button id="logout-btn" class="text-sm text-red-500 hover:text-red-700 font-medium">Logout</button>
            </header>
            
            <div id="gemini-message-box" class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-lg mb-6">
                 <p class="text-sm text-blue-800"><strong class="font-semibold">Today's Motivation:</strong> <span id="gemini-message">Loading...</span></p>
            </div>

            <main id="buttons" class="grid grid-cols-2 gap-4">
                <button id="checkin-btn" class="bg-green-500 text-white p-4 rounded-lg shadow-md hover:bg-green-600 transition disabled:bg-gray-400 disabled:cursor-not-allowed">Check In</button>
                <button id="checkout-btn" class="bg-red-500 text-white p-4 rounded-lg shadow-md hover:bg-red-600 transition disabled:bg-gray-400 disabled:cursor-not-allowed">Check Out</button>
                <button id="start-trip-btn" class="bg-yellow-500 text-white p-4 rounded-lg shadow-md hover:bg-yellow-600 transition disabled:bg-gray-400 disabled:cursor-not-allowed">Start Trip</button>
                <button id="end-trip-btn" class="bg-purple-500 text-white p-4 rounded-lg shadow-md hover:bg-purple-600 transition disabled:bg-gray-400 disabled:cursor-not-allowed">End Trip</button>
            </main>

            <div id="forms" class="hidden mt-6">
                <!-- Check-in Form -->
                <div id="checkin-form" class="hidden p-4 bg-gray-50 rounded-lg border">
                    <h3 class="font-semibold text-lg mb-3">Check In Details</h3>
                    <label for="checkin-reason" class="block text-sm font-medium text-gray-700 mb-1">Reason</label>
                    <select id="checkin-reason" class="w-full p-2 border border-gray-300 rounded-md">
                        <option>Shift Start</option>
                        <option>Break End</option>
                    </select>
                    <div class="flex gap-2 mt-4">
                        <button id="submit-checkin" class="flex-1 bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600">Submit</button>
                        <button onclick="hideForm()" class="flex-1 bg-gray-300 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-400">Cancel</button>
                    </div>
                </div>

                <!-- Check-out Form -->
                <div id="checkout-form" class="hidden p-4 bg-gray-50 rounded-lg border">
                    <h3 class="font-semibold text-lg mb-3">Check Out Details</h3>
                    <label for="checkout-reason" class="block text-sm font-medium text-gray-700 mb-1">Reason</label>
                    <select id="checkout-reason" class="w-full p-2 border border-gray-300 rounded-md">
                        <option>Shift End</option>
                        <option>Break Start</option>
                        <option>Emergency</option>
                    </select>
                    <div class="flex gap-2 mt-4">
                        <button id="submit-checkout" class="flex-1 bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600">Submit</button>
                        <button onclick="hideForm()" class="flex-1 bg-gray-300 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-400">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
            <h3 id="modal-title" class="text-lg font-bold mb-2"></h3>
            <div id="modal-loader" class="hidden mx-auto my-4">
                <div class="loader"></div>
            </div>
            <p id="modal-message" class="text-gray-600 mb-4"></p>
            <button id="modal-close-btn" class="bg-blue-600 text-white py-2 px-6 rounded-lg hover:bg-blue-700">OK</button>
        </div>
    </div>

    <script>
        const APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwqyT3i-x3E6V-iU6G98pvZEG_H9h3s_b-r7eAAnc6yq-YyJ0E73oYQh1zLgD-o7Q-B/exec';
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('login-btn').addEventListener('click', loginRider);
            document.getElementById('logout-btn').addEventListener('click', logout);
            document.getElementById('checkin-btn').addEventListener('click', () => showForm('checkin'));
            document.getElementById('checkout-btn').addEventListener('click', () => showForm('checkout'));
            document.getElementById('start-trip-btn').addEventListener('click', startTrip);
            document.getElementById('end-trip-btn').addEventListener('click', endTrip);
            document.getElementById('submit-checkin').addEventListener('click', handleCheckIn);
            document.getElementById('submit-checkout').addEventListener('click', handleCheckOut);
            document.getElementById('modal-close-btn').addEventListener('click', hideModal);
        });

        async function loginRider() {
            const riderId = document.getElementById('rider-id').value.trim().toUpperCase();
            const secretPin = document.getElementById('rider-pin').value.trim();

            if (!riderId || !secretPin) {
                showModal('Error', 'Kripya Rider ID aur Secret PIN dono daalein.');
                return;
            }
            showModal('Logging In...', 'Aapki details verify ki ja rahi hai...', false);
            
            const payload = { action: 'login', riderId: riderId, secretPin: secretPin };

            try {
                const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.status === 'success' && result.data) {
                    if (result.data.role === 'manager') {
                        // Manager Logic
                        hideModal();
                        const scriptUrl = new URL(APPS_SCRIPT_WEB_APP_URL);
                        scriptUrl.searchParams.set('page', 'dashboard');
                        window.location.href = scriptUrl.href;
                    } else {
                        // Rider Logic
                        currentUser = result.data;
                        document.getElementById('user-name').textContent = currentUser.riderName;
                        document.getElementById('login-section').classList.add('hidden');
                        document.getElementById('app-section').classList.remove('hidden');
                        hideModal();
                        updateButtonStates(currentUser.checkInCountToday, currentUser.checkedInShifts);
                        if (currentUser.checkInCountToday === 0) {
                            getMotivationalMessage(); 
                        } else {
                            document.getElementById('gemini-message-box').classList.add('hidden');
                        }
                    }
                } else {
                    showModal('Login Failed', result.message || 'Aapki Rider ID ya PIN galat hai.');
                }
            } catch (error) {
                console.error("Login Error:", error);
                showModal('Error', 'Login karne mein error aa gaya.');
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('app-section').classList.add('hidden');
            document.getElementById('login-section').classList.remove('hidden');
            document.getElementById('rider-id').value = '';
            document.getElementById('rider-pin').value = '';
        }

        function updateButtonStates(checkInCount, checkedInShifts) {
            const checkInBtn = document.getElementById('checkin-btn');
            const checkOutBtn = document.getElementById('checkout-btn');
            const startTripBtn = document.getElementById('start-trip-btn');
            const endTripBtn = document.getElementById('end-trip-btn');
            
            const isCheckedIn = (checkInCount > 0 && checkedInShifts > 0) || (currentUser.status === 'Checked In');

            checkInBtn.disabled = isCheckedIn;
            checkOutBtn.disabled = !isCheckedIn;
            startTripBtn.disabled = !isCheckedIn || currentUser.status === 'On Trip';
            endTripBtn.disabled = !isCheckedIn || currentUser.status !== 'On Trip';
        }
        
        function showForm(type) {
            document.getElementById('buttons').classList.add('hidden');
            document.getElementById('forms').classList.remove('hidden');
            if (type === 'checkin') {
                document.getElementById('checkin-form').classList.remove('hidden');
                document.getElementById('checkout-form').classList.add('hidden');
            } else {
                document.getElementById('checkout-form').classList.remove('hidden');
                document.getElementById('checkin-form').classList.add('hidden');
            }
        }

        function hideForm() {
            document.getElementById('forms').classList.add('hidden');
            document.getElementById('checkin-form').classList.add('hidden');
            document.getElementById('checkout-form').classList.add('hidden');
            document.getElementById('buttons').classList.remove('hidden');
        }

        async function handleCheckIn() {
            const reason = document.getElementById('checkin-reason').value;
            showModal('Processing...', 'Aapka check-in process ho raha hai...', false);

            const payload = { action: 'checkIn', riderId: currentUser.riderId, reason: reason };
            
            try {
                const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.status === 'success') {
                    currentUser.status = 'Checked In';
                    currentUser.checkInCountToday += 1;
                    currentUser.checkedInShifts += 1;
                    showModal('Success', 'Aap successfully check-in ho gaye hain.');
                    updateButtonStates(currentUser.checkInCountToday, currentUser.checkedInShifts);
                    hideForm();
                } else {
                    showModal('Error', result.message || 'Check-in failed.');
                }
            } catch (error) {
                showModal('Error', 'Request failed. Please try again.');
            }
        }

        async function handleCheckOut() {
            const reason = document.getElementById('checkout-reason').value;
            showModal('Processing...', 'Aapka check-out process ho raha hai...', false);

            const payload = { action: 'checkOut', riderId: currentUser.riderId, reason: reason };

            try {
                const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.status === 'success') {
                    currentUser.status = 'Checked Out';
                    currentUser.checkedInShifts -= 1;
                    showModal('Success', 'Aap successfully check-out ho gaye hain.');
                    updateButtonStates(currentUser.checkInCountToday, currentUser.checkedInShifts);
                    hideForm();
                } else {
                    showModal('Error', result.message || 'Check-out failed.');
                }
            } catch (error) {
                showModal('Error', 'Request failed. Please try again.');
            }
        }
        
        async function startTrip() {
            showModal('Processing...', 'Trip start ki ja rahi hai...', false);
            const payload = { action: 'startTrip', riderId: currentUser.riderId };

            try {
                const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.status === 'success') {
                    currentUser.status = 'On Trip';
                    showModal('Success', 'Aapki trip start ho gayi hai.');
                    updateButtonStates(currentUser.checkInCountToday, currentUser.checkedInShifts);
                } else {
                    showModal('Error', result.message || 'Trip start nahi ho payi.');
                }
            } catch (error) {
                showModal('Error', 'Request failed. Please try again.');
            }
        }

        async function endTrip() {
            showModal('Processing...', 'Trip end ki ja rahi hai...', false);
            const payload = { action: 'endTrip', riderId: currentUser.riderId };

            try {
                const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.status === 'success') {
                    currentUser.status = 'Checked In'; // Back to checked-in state
                    showModal('Success', 'Aapki trip end ho gayi hai.');
                    updateButtonStates(currentUser.checkInCountToday, currentUser.checkedInShifts);
                } else {
                    showModal('Error', result.message || 'Trip end nahi ho payi.');
                }
            } catch (error) {
                showModal('Error', 'Request failed. Please try again.');
            }
        }

        function showModal(title, message, showCloseButton = true) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            
            const loader = document.getElementById('modal-loader');
            const closeBtn = document.getElementById('modal-close-btn');

            if (showCloseButton) {
                loader.classList.add('hidden');
                closeBtn.classList.remove('hidden');
            } else {
                loader.classList.remove('hidden');
                closeBtn.classList.add('hidden');
            }
            
            document.getElementById('modal').classList.remove('hidden');
        }

        function hideModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        async function getMotivationalMessage() {
            const geminiMessageBox = document.getElementById('gemini-message-box');
            const geminiMessageSpan = document.getElementById('gemini-message');
            geminiMessageBox.classList.remove('hidden');
            
            const systemPrompt = "You are a friendly and encouraging logistics operations manager. Provide a very short, one-sentence motivational message in Hinglish (Hindi + English) for a delivery rider starting their first shift of the day. Keep it positive and brief.";
            const userQuery = "Give me a motivational message for my first delivery of the day.";
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) {
                    geminiMessageSpan.textContent = text;
                } else {
                    geminiMessageSpan.textContent = "Aaj ka din shandaar hoga! Safe ride!";
                }
            } catch (error) {
                console.error("Gemini API Error:", error);
                geminiMessageSpan.textContent = "Keep up the great work! Drive safe!";
            }
        }
    </script>
</body>
</html>

