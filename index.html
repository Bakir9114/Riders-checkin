<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RCIS (Rider Check-In System)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Apply Inter font to the body */
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4">
    <div class="flex flex-col items-center bg-white p-8 rounded-2xl shadow-xl max-w-2xl w-full">
        <h1 class="text-5xl font-extrabold text-gray-800 mb-10 text-center leading-tight">
            RCIS (Rider Check-In System)
        </h1>

        <div id="buttons" class="hidden flex flex-col sm:flex-row justify-center items-center space-y-6 sm:space-y-0 sm:space-x-8 w-full">
            <button id="check-in-button" onclick="showShiftTimeSelection('checkin')"
                    class="px-10 py-6 text-2xl font-bold text-white bg-blue-600 rounded-xl shadow-lg
                           transition-all duration-300 hover:bg-blue-700 hover:scale-105 w-full sm:w-auto
                           focus:outline-none focus:ring-4 focus:ring-blue-300">
                Check-In
            </button>
            <button onclick="openForm('https://docs.google.com/forms/d/e/1FAIpQLSdpke-yvIBQyT9BGaLj0oF9ycydW4yJ7NCGBK17L41VSdtGYw/viewform?usp=sharing&ouid=113357258141914692297', 'checkout')"
                    class="px-10 py-6 text-2xl font-bold text-white bg-green-600 rounded-xl shadow-lg
                           transition-all duration-300 hover:bg-green-700 hover:scale-105 w-full sm:w-auto
                           focus:outline-none focus:ring-4 focus:ring-green-300">
                Check-Out
            </button>
        </div>

        <div id="shift-time-selection" class="hidden mt-8 text-center flex flex-col items-center space-y-4 w-full">
            <label for="shift-time-select" class="text-xl font-semibold text-gray-700">Select Shift Time:</label>
            <select id="shift-time-select"
                    class="p-4 text-xl rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent
                           shadow-sm w-full max-w-xs sm:max-w-md">
                <option value="">Select Shift Time</option>
                <option value="7 AM to 5 PM">7 AM to 5 PM</option>
                <option value="8 AM to 6 PM">8 AM to 6 PM</option>
                <option value="4 PM to 2 AM">4 PM to 2 AM</option>
                <option value="8 PM to 6 AM">8 AM to 6 AM</option>
                <option value="10 PM to 8 AM">10 PM to 8 AM</option>
                <option value="Other (In Emergency Only)">Other (In Emergency Only)</option>
            </select>
            <button id="confirm-shift-button"
                    class="px-8 py-4 text-xl font-bold text-white bg-blue-600 rounded-xl shadow-lg
                           transition-all duration-300 hover:bg-blue-700 hover:scale-105
                           focus:outline-none focus:ring-4 focus:ring-blue-300">
                Confirm Shift
            </button>
        </div>

        <p id="access-denied" class="hidden text-red-600 text-2xl font-semibold mt-12 text-center">
            Access denied: You are not within the allowed location range.
        </p>
    </div>

    <div id="custom-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center transform scale-95 opacity-0 transition-all duration-300" id="modal-content-wrapper">
            <h3 id="modal-title" class="text-2xl font-bold text-gray-800 mb-4"></h3>
            <p id="modal-message" class="text-lg text-gray-700 mb-6"></p>
            <div id="modal-timer-display" class="text-xl font-bold text-red-600 mb-4"></div>
            <button onclick="hideModal()"
                    class="px-6 py-3 text-lg font-semibold text-white bg-blue-600 rounded-lg shadow-md
                           transition-all duration-300 hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300">
                OK
            </button>
        </div>
    </div>

    <script>
        let mainPageReloadTimer;
        // IMPORTANT: Apne deploy kiye gaye Apps Script Web App ka URL yahaan paste karein.
        const APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/a/macros/farmako.ai/s/AKfycbxJ3zMJbkKf25xe9hQ4bBPR8LTOSSJ_5AVOVB3zN3ET_FGQWdWzP8GgKadUuCO1fYg/exec';

        function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function showModal(title, message) {
            const modal = document.getElementById('custom-modal');
            const modalContentWrapper = document.getElementById('modal-content-wrapper');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerText = message;
            modal.classList.remove('hidden');
            setTimeout(() => {
                modalContentWrapper.classList.remove('scale-95', 'opacity-0');
                modalContentWrapper.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function hideModal() {
            if (window.countdownInterval) {
                clearInterval(window.countdownInterval);
            }
            const modal = document.getElementById('custom-modal');
            const modalContentWrapper = document.getElementById('modal-content-wrapper');
            modalContentWrapper.classList.remove('scale-100', 'opacity-100');
            modalContentWrapper.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        /**
         * Starts a 2-minute timer that makes the page unusable.
         * Clears any previously set timer.
         */
        function startMainPageTimer() {
            clearTimeout(mainPageReloadTimer); // Ensure only one timer is active
            mainPageReloadTimer = setTimeout(() => {
                // Hide all interactive elements
                document.getElementById('buttons').classList.add('hidden');
                document.getElementById('shift-time-selection').classList.add('hidden');
                document.querySelector('h1').style.display = 'none'; // Hide the main heading as well

                // Show a permanent timeout message
                const accessDeniedP = document.getElementById('access-denied');
                accessDeniedP.innerText = 'Session time out. Kripya link se dobara kholein.';
                accessDeniedP.classList.remove('hidden');

                // Show a final modal message
                showModal('Session Time Out', 'Is page ka samay samapt ho gaya hai. Ise dobara istemal karne ke liye link se kholein.');

            }, 120000); // 2 minutes (120000 milliseconds)
        }

        function checkLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const userLat = position.coords.latitude;
                    const userLon = position.coords.longitude;
                    const allowedLat = 28.460845;
                    const allowedLon = 77.079439;
                    const distance = getDistanceFromLatLonInMeters(userLat, userLon, allowedLat, allowedLon);

                    if (distance <= 200) {
                        document.getElementById('buttons').classList.remove('hidden');
                        document.getElementById('access-denied').classList.add('hidden');
                        startMainPageTimer();
                    } else {
                        document.getElementById('access-denied').classList.remove('hidden');
                        document.getElementById('buttons').classList.add('hidden');
                        showModal('Location Error', `पहुँच अस्वीकृत: आप अनुमत स्थान से ${Math.round(distance)} मीटर दूर हैं। कृपया करीब आएं।`);
                    }
                }, error => {
                    console.error("Geolocation error:", error.code, error.message);
                    let errorMessage = 'Geolocation पहुँच अस्वीकृत। ';
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += "अनुमति अस्वीकृत। कृपया अपने ब्राउज़र सेटिंग्स में स्थान पहुँच की अनुमति दें।";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += "स्थान की जानकारी अनुपलब्ध है।";
                            break;
                        case error.TIMEOUT:
                            errorMessage += "आपका स्थान प्राप्त करने का अनुरोध समय समाप्त हो गया।";
                            break;
                        default:
                            errorMessage += "एक अज्ञात त्रुटि हुई।";
                            break;
                    }
                    showModal('Geolocation त्रुटि', errorMessage);
                    document.getElementById('buttons').classList.add('hidden');
                    document.getElementById('access-denied').classList.remove('hidden');
                }, { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 });
            } else {
                showModal('ब्राउज़र त्रुटि', 'इस ब्राउज़र द्वारा Geolocation समर्थित नहीं है।');
                document.getElementById('buttons').classList.add('hidden');
                document.getElementById('access-denied').classList.remove('hidden');
            }
        }
        
        function openForm(url, formType) {
            let formWindow = window.open(url, '_blank', 'noopener,noreferrer');
            if (formWindow) {
                clearTimeout(mainPageReloadTimer);
                showModal('Samay Seema', 'Kripya dhyan dein, form 2 minute ke baad apne aap band ho jayega.');
                startCountdownInModal(120);

                if (APPS_SCRIPT_WEB_APP_URL && !APPS_SCRIPT_WEB_APP_URL.includes('YOUR_DEPLOYMENT_ID')) {
                    const appsScriptUrlWithParam = `${APPS_SCRIPT_WEB_APP_URL}?type=${formType}`;
                    fetch(appsScriptUrlWithParam)
                        .then(response => response.text())
                        .then(data => console.log("Apps Script Response:", data))
                        .catch(error => console.error('Error calling Apps Script:', error));
                } else {
                    console.warn("Apps Script Web App URL is not defined or is a placeholder.");
                }

                const formTimeout = setTimeout(() => {
                    if (formWindow && !formWindow.closed) {
                        formWindow.close();
                        showModal('Samay Samapt', 'Form bharne ka samay samapt ho gaya hai. Page ab refresh hoga.');
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    }
                }, 120000);

                let checkClosed = setInterval(function() {
                    if (!formWindow || formWindow.closed) {
                        clearInterval(checkClosed);
                        clearTimeout(formTimeout);
                        if (window.countdownInterval) {
                            clearInterval(window.countdownInterval);
                        }
                        window.location.reload();
                    }
                }, 1000);
            } else {
                showModal('पॉप-अप ब्लॉक किया गया', "पॉप-अप ब्लॉक किया गया। फॉर्म खोलने के लिए कृपया इस साइट के लिए पॉप-अप की अनुमति दें।");
                startMainPageTimer();
            }
        }
        
        function startCountdownInModal(duration) {
            if (window.countdownInterval) {
                clearInterval(window.countdownInterval);
            }
            const timerDisplay = document.getElementById('modal-timer-display');
            let timer = duration;
            let minutes, seconds;
            window.countdownInterval = setInterval(() => {
                minutes = parseInt(timer / 60, 10);
                seconds = parseInt(timer % 60, 10);
                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;
                timerDisplay.textContent = `Samay Shesh: ${minutes}:${seconds}`;
                if (--timer < 0) {
                    clearInterval(window.countdownInterval);
                    timerDisplay.textContent = "Samay Samapt!";
                }
            }, 1000);
        }

        function showShiftTimeSelection(action) {
            const shiftTimeSelection = document.getElementById('shift-time-selection');
            const confirmShiftButton = document.getElementById('confirm-shift-button');
            if (action === 'checkin') {
                document.getElementById('buttons').classList.add('hidden');
                shiftTimeSelection.classList.remove('hidden');
                startMainPageTimer();
                confirmShiftButton.onclick = function() {
                    const shiftTime = document.getElementById('shift-time-select').value;
                    if (shiftTime) {
                        // ZAROORI: Yahan apne Check-In form ki asli 'entry ID' daalein.
                        // 'entry.1234567890' ko apne form ki ID se replace karein.
                        const checkInUrl = `https://docs.google.com/forms/d/e/1FAIpQLSeGZFsMNslzWn1iIqBb0GNafZrhx5zK0ppDcNvEyRdgieulHg/viewform?usp=sharing&ouid=113357258141914692297&entry.1234567890=${encodeURIComponent(shiftTime)}`;
                        openForm(checkInUrl, 'checkin');
                    } else {
                        showModal('चयन आवश्यक', 'कृपया आगे बढ़ने से पहले अपनी शिफ्ट का समय चुनें।');
                        startMainPageTimer();
                    }
                };
            }
        }

        document.addEventListener('contextmenu', event => event.preventDefault());
        document.addEventListener('DOMContentLoaded', function() {
            checkLocation();
        });
    </script>
</body>
</html>
